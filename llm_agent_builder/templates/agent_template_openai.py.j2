import os
from typing import Optional, List, Dict, Any
try:
    import openai
    OPENAI_AVAILABLE = True
except ImportError:
    OPENAI_AVAILABLE = False
{% if enable_multi_step or tools %}
import json
{% endif %}

class {% if agent_name %}{{ agent_name }}{% else %}Agent{% endif %}:
    def __init__(self, api_key):
        if not OPENAI_AVAILABLE:
            raise ImportError("OpenAI not available. Please install with: pip install openai")
        self.client = openai.OpenAI(api_key=api_key)
        self.model = "{{- model -}}"
        self.prompt = "{{- prompt -}}"
        {% if tools %}
        self.tools = {{ tools | tojson }}
        {% endif %}

    {% if tools %}
    def _execute_tool(self, tool_name: str, tool_input: Dict[str, Any]) -> Dict[str, Any]:
        """Execute a tool call. Override this method to implement custom tool logic."""
        # Default implementation - override in subclass for custom tools
        return {"result": f"Tool {tool_name} executed with input: {tool_input}"}
    {% endif %}

    {% if enable_multi_step %}
    def run_multi_step(self, task: str, max_steps: int = 5) -> str:
        """Run a multi-step workflow where the agent can iterate on the task."""
        messages = [{"role": "user", "content": f"{self.prompt}\n\nTask: {task}"}]
        final_result = None

        for step in range(max_steps):
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7
            )

            # Extract response content
            final_result = response.choices[0].message.content
            if final_result is None:
                final_result = "No response content received"

            messages.append({
                "role": "assistant",
                "content": final_result
            })

            # Check if task is complete (simple heuristic - can be enhanced)
            if final_result and ("complete" in final_result.lower() or "finished" in final_result.lower()):
                break

            # Add continuation prompt for next step
            if step < max_steps - 1:
                messages.append({
                    "role": "user",
                    "content": "Continue or refine your response if needed."
                })

        return final_result or "Multi-step workflow completed."
    {% endif %}

    def run(self, task: str{% if enable_multi_step %}, use_multi_step: bool = False{% endif %}):
        {% if enable_multi_step %}
        if use_multi_step:
            return self.run_multi_step(task)
        {% endif %}

        # Use OpenAI chat completion API
        messages = [
            {"role": "system", "content": self.prompt},
            {"role": "user", "content": task}
        ]

        response = self.client.chat.completions.create(
            model=self.model,
            messages=messages,
            temperature=0.7
        )

        result = response.choices[0].message.content
        return result if result is not None else "No response content received"

if __name__ == '__main__':
    import os
    import argparse
    from dotenv import load_dotenv

    load_dotenv()

    # Parse command line arguments
    parser = argparse.ArgumentParser(description="Run the {% if agent_name %}{{ agent_name }}{% else %}Agent{% endif %} agent.")
    parser.add_argument("--task", default="{{- example_task -}}", help="The task to be performed by the agent")
    args = parser.parse_args()

    # Ensure API key is set (OpenAI API key)
    api_key = os.environ.get("OPENAI_API_KEY")
    if not api_key:
        raise ValueError("OPENAI_API_KEY environment variable not set. Please set it in your .env file or environment.")

    try:
        agent = {% if agent_name %}{{ agent_name }}{% else %}Agent{% endif %}(api_key=api_key)
        print(f"Running {% if agent_name %}{{ agent_name }}{% else %}Agent{% endif %} with task: {args.task}\n")
        result = agent.run(args.task)
        print("Response:")
        print("-" * 50)
        print(result)
        print("-" * 50)
    except Exception as e:
        print(f"Error running agent: {e}")
