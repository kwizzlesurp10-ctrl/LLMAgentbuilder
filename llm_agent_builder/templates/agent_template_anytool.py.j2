
import asyncio
import os
from typing import Optional, List, Dict, Any
from llm_agent_builder.anytool.tool_layer import AnyTool, AnyToolConfig

class {{ agent_name }}:
    def __init__(self, api_key: str):
        self.api_key = api_key
        # AnyTool uses its own LLM configuration, we'text use the provided model
        self.config = AnyToolConfig(
            llm_model="{{ model }}",
            grounding_system_prompt="{{- prompt -}}",
            {% if provider == 'openai' %}
            llm_kwargs={"api_key": api_key}
            {% else %}
            llm_kwargs={"api_key": api_key}
            {% endif %}
        )
        self.anytool = AnyTool(self.config)
        self._initialized = False

    async def initialize(self):
        if not self._initialized:
            await self.anytool.initialize()
            self._initialized = True

    async def run_async(self, task: str) -> str:
        await self.initialize()
        result = await self.anytool.execute(task)
        
        if result.get("status") == "success":
            return result.get("response", "Task completed successfully.")
        else:
            return f"Error: {result.get('error', 'Unknown error')}\nDetails: {result.get('response', '')}"

    def run(self, task: str) -> str:
        """Synchronous wrapper for AnyTool execution."""
        return asyncio.run(self.run_async(task))

if __name__ == '__main__':
    import os
    import argparse
    from dotenv import load_dotenv

    load_dotenv()

    # Parse command line arguments
    parser = argparse.ArgumentParser(description="Run the {{ agent_name }} agent with AnyTool.")
    parser.add_argument("--task", default="{{- example_task -}}", help="The task to be performed by the agent")
    args = parser.parse_args()

    # Ensure API key is set
    # AnyTool might use different keys based on the model string
    api_key = os.environ.get("ANTHROPIC_API_KEY") or os.environ.get("OPENAI_API_KEY") or os.environ.get("HUGGINGFACEHUB_API_TOKEN")
    if not api_key:
        raise ValueError("API key not found. Please set ANTHROPIC_API_KEY, OPENAI_API_KEY, or HUGGINGFACEHUB_API_TOKEN.")

    try:
        agent = {{ agent_name }}(api_key=api_key)
        print(f"Running {{ agent_name }} (AnyTool) with task: {args.task}\n")
        result = agent.run(args.task)
        print("Response:")
        print("-" * 50)
        print(result)
        print("-" * 50)
    except Exception as e:
        print(f"Error running agent: {e}")
